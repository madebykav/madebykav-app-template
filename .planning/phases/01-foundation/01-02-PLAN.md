---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - src/lib/db/schema.ts
  - src/lib/db/index.ts
  - src/app/globals.css
  - tailwind.config.ts
autonomous: true
requirements:
  - SCHM-01
  - SCHM-02
  - SCHM-03
  - APP-04
  - APP-05

must_haves:
  truths:
    - "schema.ts defines RLS policy inline via pgPolicy() and createTenantPolicy()"
    - "db/index.ts does not re-export withTenant or withoutRLS"
    - "globals.css has @source directive for SDK component scanning"
    - "tailwind.config.ts is deleted"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "Declarative RLS via pgPolicy"
      contains: "pgPolicy.*createTenantPolicy"
    - path: "src/lib/db/index.ts"
      provides: "Clean database connection without SDK re-exports"
    - path: "src/app/globals.css"
      provides: "Tailwind v4 with SDK class scanning"
      contains: "@source.*@madebykav/ui"
  key_links:
    - from: "src/lib/db/schema.ts"
      to: "drizzle-orm/pg-core"
      via: "pgPolicy import"
      pattern: "import.*pgPolicy.*from.*drizzle-orm/pg-core"
    - from: "src/lib/db/schema.ts"
      to: "@madebykav/db"
      via: "createTenantPolicy import"
      pattern: "import.*createTenantPolicy.*from.*@madebykav/db"
    - from: "src/app/globals.css"
      to: "node_modules/@madebykav/ui"
      via: "@source directive"
      pattern: "@source.*node_modules/@madebykav/ui"
---

<objective>
Rewrite schema.ts with declarative RLS via pgPolicy(), clean up db/index.ts re-exports, migrate globals.css to Tailwind v4 with @source directive, and delete the legacy tailwind.config.ts.

Purpose: Move RLS policy definition into the schema (version-controlled, declarative) and complete the Tailwind v4 CSS-first migration. After this plan, the codebase uses modern patterns for both RLS and styling configuration.

Output: Updated schema with inline RLS, clean db/index.ts, Tailwind v4 CSS config with SDK scanning, no legacy tailwind.config.ts.
</objective>

<execution_context>
@/Users/kavinda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kavinda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@APP-TEMPLATE-UPDATE-FINAL.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite schema.ts with declarative RLS and clean up db/index.ts</name>
  <files>src/lib/db/schema.ts, src/lib/db/index.ts</files>
  <action>
**src/lib/db/schema.ts** -- Replace entire contents with the exact spec from APP-TEMPLATE-UPDATE-FINAL.md section 5:

```typescript
import { pgTable, pgPolicy, uuid, text, timestamp, integer } from 'drizzle-orm/pg-core'
import { createTenantPolicy } from '@madebykav/db'

/**
 * Example table with declarative RLS.
 *
 * Key patterns:
 * 1. Every table has a tenant_id column (multiple tenants use the same app)
 * 2. RLS policy defined in the schema via pgPolicy() + createTenantPolicy()
 * 3. Always query through withTenant() from @madebykav/db
 */
export const exampleItems = pgTable('example_items', {
  id: uuid('id').defaultRandom().primaryKey(),
  tenantId: uuid('tenant_id').notNull(),
  title: text('title').notNull(),
  description: text('description'),
  status: text('status').notNull().default('pending'),
  priority: integer('priority').default(0),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
}, (table) => [
  pgPolicy('example_items_tenant_isolation', createTenantPolicy()),
])

export type ExampleItem = typeof exampleItems.$inferSelect
export type NewExampleItem = typeof exampleItems.$inferInsert
```

Key changes from current:
- Add `pgPolicy` to the import from `drizzle-orm/pg-core`
- Change `tenantRlsPolicy` import to `createTenantPolicy` from `@madebykav/db`
- Add third argument to `pgTable()` with the policy array
- Remove all comments about manually running `SELECT create_tenant_policy(...)` and the bottom `tenantRlsPolicy` documentation block

**src/lib/db/index.ts** -- Replace entire contents with the exact spec from APP-TEMPLATE-UPDATE-FINAL.md section 6:

```typescript
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'
import * as schema from './schema'

const client = postgres(process.env.DATABASE_URL!, {
  prepare: false,
})

export const db = drizzle(client, { schema })
export type Database = typeof db
```

Key changes from current:
- Remove `export { withTenant, withoutRLS } from '@madebykav/db'` re-export line
- Remove all comments (the code is self-explanatory)
- Remove the `connectionString` intermediate variable (inline it)

Note on SCHM-03: The current codebase already imports `withTenant` directly from `@madebykav/db` in page.tsx and route.ts. Removing the re-export from db/index.ts does not break any imports. Verify with a grep after changes.
  </action>
  <verify>
- `grep 'pgPolicy' src/lib/db/schema.ts` finds the policy definition
- `grep 'createTenantPolicy' src/lib/db/schema.ts` finds the import and usage
- `grep 'tenantRlsPolicy' src/lib/db/schema.ts` returns nothing (old import removed)
- `grep 'withTenant\|withoutRLS' src/lib/db/index.ts` returns nothing (re-exports removed)
- `grep -r "from '@/lib/db'" src/ --include='*.ts' --include='*.tsx'` shows no file imports withTenant from the local db module
- Run `npx tsc --noEmit` to confirm no TypeScript errors (requires drizzle-orm ^0.45.0 from Plan 01)
  </verify>
  <done>schema.ts has pgPolicy() with createTenantPolicy() in the pgTable third argument. db/index.ts has no SDK re-exports. No TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add @source directive to globals.css and delete tailwind.config.ts</name>
  <files>src/app/globals.css, tailwind.config.ts</files>
  <action>
**src/app/globals.css** -- Replace entire contents with the exact spec from APP-TEMPLATE-UPDATE-FINAL.md section 13:

```css
@import "tailwindcss";
@import "@madebykav/ui/globals.css";

@source "../node_modules/@madebykav/ui/**/*.{js,ts,jsx,tsx}";

/* App-specific theme overrides (optional) */
@theme inline {
  /* --color-brand: oklch(60% 0.25 12); */
}

body {
  @apply bg-background text-foreground antialiased;
}
```

Key change: Add `@source "../node_modules/@madebykav/ui/**/*.{js,ts,jsx,tsx}"` after the imports. This tells Tailwind v4 to scan the SDK package for utility class usage (node_modules is excluded by default). Also simplify the @theme block comments.

**tailwind.config.ts** -- DELETE this file entirely. Tailwind v4 uses CSS-first config. The `content` array is replaced by `@source` in globals.css. The `darkMode: 'class'` setting is the default in v4 and doesn't need explicit configuration.

Use `rm tailwind.config.ts` or the equivalent file deletion approach.
  </action>
  <verify>
- `grep '@source' src/app/globals.css` finds the @source directive
- `grep '@madebykav/ui' src/app/globals.css` finds both the import and the @source
- `ls tailwind.config.ts 2>/dev/null` returns nothing (file deleted)
- Run `pnpm build` to confirm Tailwind v4 compiles correctly with the new CSS config (no JS config needed)
  </verify>
  <done>globals.css has @source directive for SDK scanning. tailwind.config.ts is deleted. pnpm build succeeds with Tailwind v4 CSS-first configuration.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep 'pgPolicy.*createTenantPolicy' src/lib/db/schema.ts` confirms declarative RLS
2. `grep -c 'withTenant\|withoutRLS' src/lib/db/index.ts` returns 0
3. `grep '@source.*@madebykav/ui' src/app/globals.css` confirms SDK scanning
4. `test -f tailwind.config.ts && echo "EXISTS" || echo "DELETED"` returns DELETED
5. `npx tsc --noEmit` passes with no type errors
6. `pnpm build` succeeds (validates TypeScript + Tailwind compilation end-to-end)
</verification>

<success_criteria>
- schema.ts uses pgPolicy() with createTenantPolicy() as third argument to pgTable()
- db/index.ts exports only db and Database (no withTenant/withoutRLS re-exports)
- No file in src/ imports withTenant from '@/lib/db' (all import from '@madebykav/db')
- globals.css has @source directive scanning @madebykav/ui in node_modules
- tailwind.config.ts does not exist
- pnpm build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
