---
phase: 03-app-code-cicd
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/example/route.ts
  - .github/workflows/docker-publish.yml
autonomous: true
requirements:
  - APP-03
  - CICD-01

must_haves:
  truths:
    - "API example POST route uses satisfies NewExampleItem for inline type checking"
    - "GitHub Actions workflow triggers on push to main and builds Docker image"
    - "Docker image is tagged with SHA and latest, and pushed to GHCR"
    - "BuildKit secrets input matches Dockerfile's --mount=type=secret,id=GITHUB_TOKEN pattern"
  artifacts:
    - path: "src/app/api/example/route.ts"
      provides: "API route with satisfies type pattern"
      contains: "satisfies NewExampleItem"
    - path: ".github/workflows/docker-publish.yml"
      provides: "CI/CD pipeline for Docker image publishing"
      contains: "docker/build-push-action"
  key_links:
    - from: ".github/workflows/docker-publish.yml"
      to: "Dockerfile"
      via: "docker/build-push-action with secrets input"
      pattern: "GITHUB_TOKEN.*secrets"
    - from: ".github/workflows/docker-publish.yml"
      to: "ghcr.io"
      via: "docker/login-action registry login"
      pattern: "ghcr.io"
---

<objective>
Update API example route to use TypeScript `satisfies` operator (APP-03) and create GitHub Actions CI/CD workflow for Docker image publishing to GHCR (CICD-01).

Purpose: Tighter type checking in API routes and automated Docker image builds on push to main.
Output: Updated route.ts with satisfies pattern, new .github/workflows/docker-publish.yml
</objective>

<execution_context>
@/Users/kavinda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kavinda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-app-code-cicd/03-RESEARCH.md
@src/app/api/example/route.ts
@Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update API example route with satisfies operator</name>
  <files>src/app/api/example/route.ts</files>
  <action>
**API route (APP-03):**
In the POST handler of `src/app/api/example/route.ts`, replace the intermediate variable pattern with inline `satisfies`:

**Before (current):**
```typescript
const [item] = await withTenant(db, auth.tenantId, async (tx) => {
    const newItem: NewExampleItem = {
      tenantId: auth.tenantId,
      title,
      description,
      priority: priority ?? 0,
    }

    return tx.insert(exampleItems).values(newItem).returning()
  })
```

**After:**
```typescript
const [item] = await withTenant(db, auth.tenantId, async (tx) => {
    return tx.insert(exampleItems).values({
      tenantId: auth.tenantId,
      title,
      description,
      priority: priority ?? 0,
    } satisfies NewExampleItem).returning()
  })
```

Key changes:
- Remove `const newItem: NewExampleItem = {...}` intermediate variable
- Move object literal inline to `.values()` with `satisfies NewExampleItem`
- `satisfies` provides stricter type checking (catches excess properties) vs variable annotation
- Keep `NewExampleItem` import -- it's still needed for the satisfies operator
- Do NOT change the GET handler or any other part of the file
  </action>
  <verify>
1. `grep "satisfies NewExampleItem" src/app/api/example/route.ts` should match
2. `grep -c "const newItem" src/app/api/example/route.ts` should return 0 (intermediate variable removed)
3. `grep "NewExampleItem" src/app/api/example/route.ts` should appear in both import and satisfies usage
  </verify>
  <done>
- POST handler uses `{...} satisfies NewExampleItem` inline in .values() call
- No intermediate `const newItem` variable
- NewExampleItem is still imported from schema
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI/CD workflow for Docker publishing</name>
  <files>.github/workflows/docker-publish.yml</files>
  <action>
**CI/CD workflow (CICD-01):**
Create `.github/workflows/docker-publish.yml`. Note: the `.github/` directory does NOT exist yet -- create the full path `.github/workflows/`.

```yaml
name: Build and Publish Docker Image

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          secrets: |
            "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}"
```

Key implementation details:
- **Trigger**: push to main + manual workflow_dispatch (no PR builds per spec)
- **Permissions**: `packages: write` for GHCR push, `contents: read` for checkout
- **Registry login**: `docker/login-action@v3` with GHCR using automatic `secrets.GITHUB_TOKEN`
- **Tags**: `type=sha` produces `sha-abc1234` format; `type=raw,value=latest` on default branch only
- **BuildKit secrets**: Uses `secrets` input (NOT `build-args`) to match Dockerfile's `--mount=type=secret,id=GITHUB_TOKEN`. This is CRITICAL -- the Dockerfile from Phase 2 uses `RUN --mount=type=secret,id=GITHUB_TOKEN` during pnpm install
- **Action versions**: checkout@v4, login-action@v3, metadata-action@v5, build-push-action@v6

Note on GITHUB_TOKEN scope: The automatic `secrets.GITHUB_TOKEN` is used for both GHCR login and as a BuildKit secret for pnpm install. If cross-org package access fails (401 during pnpm install), a separate PAT with `read:packages` scope will need to be added as a repository secret. This is documented in research but not actionable until the workflow runs.
  </action>
  <verify>
1. `test -f .github/workflows/docker-publish.yml && echo "exists"` should print "exists"
2. `grep "docker/build-push-action@v6" .github/workflows/docker-publish.yml` should match
3. `grep "secrets:" .github/workflows/docker-publish.yml` should match (BuildKit secrets, not build-args)
4. `grep -c "build-args" .github/workflows/docker-publish.yml` should return 0 (no build-args used)
5. `grep "type=sha" .github/workflows/docker-publish.yml` should match (SHA tagging)
6. `grep "type=raw,value=latest" .github/workflows/docker-publish.yml` should match (latest tag)
7. `grep "packages: write" .github/workflows/docker-publish.yml` should match (GHCR push permission)
  </verify>
  <done>
- .github/workflows/docker-publish.yml exists and triggers on push to main
- Uses docker/build-push-action@v6 with secrets input (not build-args) matching Dockerfile's BuildKit pattern
- Tags images with SHA and latest (on default branch)
- Logs into GHCR with docker/login-action@v3
- Has packages:write permission for GHCR push
  </done>
</task>

</tasks>

<verification>
1. `grep "satisfies NewExampleItem" src/app/api/example/route.ts` matches
2. `test -f .github/workflows/docker-publish.yml && echo "exists"` prints "exists"
3. `grep "secrets:" .github/workflows/docker-publish.yml` matches (BuildKit secrets used)
4. `grep -c "build-args" .github/workflows/docker-publish.yml` returns 0
5. `grep "push:" .github/workflows/docker-publish.yml` matches (push enabled)
6. `grep "ghcr.io" .github/workflows/docker-publish.yml` matches (GHCR registry)
</verification>

<success_criteria>
- API example route POST handler uses `satisfies NewExampleItem` inline (no intermediate variable)
- .github/workflows/docker-publish.yml triggers on push to main, builds Docker image, and pushes to GHCR
- Docker image tagged with SHA + latest
- BuildKit secrets input used (not build-args) to match Dockerfile's secret mount pattern
</success_criteria>

<output>
After completion, create `.planning/phases/03-app-code-cicd/03-02-SUMMARY.md`
</output>
