---
phase: 03-app-code-cicd
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/layout.tsx
  - src/app/page.tsx
  - src/app/actions/auth.ts
autonomous: true
requirements:
  - APP-01
  - APP-02
  - AUTH-01

must_haves:
  truths:
    - "Root layout does not call getAuthContext() and is not async (pages can be statically optimized)"
    - "Dashboard page shows auth context fields: tenantSlug, role, email, userId after null check"
    - "Welcome message displays auth.name or auth.email"
    - "Unauthenticated users see 'Not Authenticated' card instead of empty dashboard"
    - "Logout server action exists and redirects to platform /logout endpoint"
  artifacts:
    - path: "src/app/layout.tsx"
      provides: "Root layout without auth call"
      contains: "function RootLayout"
    - path: "src/app/page.tsx"
      provides: "Dashboard with v0.2.0 AuthContext pattern"
      contains: "if (!auth)"
    - path: "src/app/actions/auth.ts"
      provides: "Logout server action"
      contains: "use server"
  key_links:
    - from: "src/app/page.tsx"
      to: "@madebykav/auth"
      via: "getAuthContext() import"
      pattern: "getAuthContext"
    - from: "src/app/actions/auth.ts"
      to: "next/navigation"
      via: "redirect() import"
      pattern: "redirect.*PLATFORM_URL.*logout"
---

<objective>
Update app code for auth SDK v0.2.0 breaking changes: remove getAuthContext() from root layout (APP-01), rewrite page.tsx with new AuthContext null-check pattern and new fields (APP-02), and create a logout server action (AUTH-01).

Purpose: App code correctly uses the auth SDK v0.2.0 patterns, enabling static optimization for non-auth pages and providing a working logout mechanism.
Output: Updated layout.tsx, page.tsx, and new src/app/actions/auth.ts
</objective>

<execution_context>
@/Users/kavinda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kavinda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-app-code-cicd/03-RESEARCH.md
@src/app/layout.tsx
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update layout.tsx and create logout server action</name>
  <files>src/app/layout.tsx, src/app/actions/auth.ts</files>
  <action>
**layout.tsx (APP-01):**
Replace the entire content of `src/app/layout.tsx` with:
- Remove `import { getAuthContext } from '@madebykav/auth'`
- Remove `const auth = await getAuthContext()` call and its comments
- Make function non-async: `export default function RootLayout` (not `async function`)
- Add body classes: `bg-background text-foreground antialiased` to existing `min-h-screen`
- Remove the commented-out AuthProvider block
- Keep: metadata export, `./globals.css` import, `html` with `suppressHydrationWarning`, `children` rendering

Target layout.tsx:
```typescript
import type { Metadata } from 'next'
import './globals.css'

export const metadata: Metadata = {
  title: 'App Template | MadeByKav',
  description: 'A template for building apps on the MadeByKav platform',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body className="min-h-screen bg-background text-foreground antialiased">
        {children}
      </body>
    </html>
  )
}
```

**Logout server action (AUTH-01):**
Create `src/app/actions/auth.ts`:
```typescript
'use server'

import { redirect } from 'next/navigation'

export async function logout() {
  redirect(`${process.env.PLATFORM_URL || 'https://madebykav.com'}/logout`)
}
```

Key rules:
- `redirect()` must NOT be wrapped in try/catch (it throws NEXT_REDIRECT internally)
- `'use server'` directive at top of file marks all exports as server actions
- `PLATFORM_URL` env var is already in `.env.example`
  </action>
  <verify>
1. Verify layout.tsx does NOT contain `getAuthContext` or `async`: `grep -c "getAuthContext\|async function" src/app/layout.tsx` should return 0
2. Verify layout.tsx contains correct body classes: `grep "bg-background text-foreground antialiased" src/app/layout.tsx`
3. Verify auth.ts exists with 'use server' directive: `head -1 src/app/actions/auth.ts` should show `'use server'`
4. Verify redirect to platform logout: `grep "PLATFORM_URL.*logout" src/app/actions/auth.ts`
  </verify>
  <done>
- layout.tsx has no getAuthContext import, no async keyword, no auth call, and body has bg-background text-foreground antialiased classes
- src/app/actions/auth.ts exists with 'use server' directive and redirect to PLATFORM_URL/logout
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite page.tsx with v0.2.0 AuthContext pattern</name>
  <files>src/app/page.tsx</files>
  <action>
**page.tsx (APP-02):**
Replace the entire content of `src/app/page.tsx` to use the v0.2.0 AuthContext null-check pattern.

Key changes from current code:
1. **Null check replaces optional chaining**: `if (!auth)` with early return showing "Not Authenticated" card, instead of `if (auth?.tenantId)` conditional wrapper
2. **Welcome message with new fields**: `Welcome, {auth.name || auth.email}` instead of static "Welcome to your app template"
3. **Auth Context card shows new fields**: `tenantSlug`, `role`, `email`, `userId` (replaces `tenantId`, `tenantSlug`, `userId`, `Status`)
4. **No optional chaining after null check**: After `if (!auth) return`, TypeScript narrows auth to non-null, so use `auth.tenantId` not `auth?.tenantId`
5. **Items query outside conditional**: `withTenant` call is unconditional after the null check (auth is guaranteed non-null)
6. **Remove `let items` variable declaration**: Items are assigned directly from withTenant call

Target page.tsx:
```typescript
import { getAuthContext } from '@madebykav/auth'
import { withTenant } from '@madebykav/db'
import { Button, Card } from '@madebykav/ui'
import { db } from '@/lib/db'
import { exampleItems } from '@/lib/db/schema'

export default async function DashboardPage() {
  const auth = await getAuthContext()

  if (!auth) {
    return (
      <main className="container mx-auto p-8">
        <Card className="p-6">
          <h2 className="text-xl font-semibold mb-2">Not Authenticated</h2>
          <p className="text-muted-foreground">
            Please log in through the platform portal.
          </p>
        </Card>
      </main>
    )
  }

  const items = await withTenant(db, auth.tenantId, async (tx) => {
    return tx.select({
      id: exampleItems.id,
      title: exampleItems.title,
      status: exampleItems.status,
    }).from(exampleItems).limit(5)
  })

  return (
    <main className="container mx-auto p-8">
      <div className="space-y-8">
        {/* Header */}
        <div>
          <h1 className="text-3xl font-bold">Dashboard</h1>
          <p className="text-muted-foreground mt-2">
            Welcome, {auth.name || auth.email}
          </p>
        </div>

        {/* Auth Context */}
        <Card className="p-6">
          <h2 className="text-xl font-semibold mb-4">Authentication Context</h2>
          <div className="grid grid-cols-2 gap-4 text-sm">
            <div>
              <span className="text-muted-foreground">Tenant:</span>
              <p className="font-mono">{auth.tenantSlug}</p>
            </div>
            <div>
              <span className="text-muted-foreground">Role:</span>
              <p className="font-mono">{auth.role}</p>
            </div>
            <div>
              <span className="text-muted-foreground">User:</span>
              <p className="font-mono">{auth.email}</p>
            </div>
            <div>
              <span className="text-muted-foreground">User ID:</span>
              <p className="font-mono text-xs">{auth.userId}</p>
            </div>
          </div>
        </Card>

        {/* Stats Cards */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <Card className="p-6">
            <h3 className="text-sm text-muted-foreground">Total Items</h3>
            <p className="text-3xl font-bold mt-2">{items.length}</p>
          </Card>
          <Card className="p-6">
            <h3 className="text-sm text-muted-foreground">Pending</h3>
            <p className="text-3xl font-bold mt-2">
              {items.filter(i => i.status === 'pending').length}
            </p>
          </Card>
          <Card className="p-6">
            <h3 className="text-sm text-muted-foreground">Completed</h3>
            <p className="text-3xl font-bold mt-2">
              {items.filter(i => i.status === 'completed').length}
            </p>
          </Card>
        </div>

        {/* Actions */}
        <Card className="p-6">
          <h2 className="text-xl font-semibold mb-4">Quick Actions</h2>
          <div className="flex gap-4">
            <Button>Create Item</Button>
            <Button variant="secondary">View All</Button>
            <Button variant="outline">Settings</Button>
          </div>
        </Card>

        {/* Recent Items */}
        <Card className="p-6">
          <h2 className="text-xl font-semibold mb-4">Recent Items</h2>
          {items.length > 0 ? (
            <ul className="space-y-2">
              {items.map((item) => (
                <li key={item.id} className="flex justify-between items-center p-2 border rounded">
                  <span>{item.title}</span>
                  <span className="text-sm text-muted-foreground">{item.status}</span>
                </li>
              ))}
            </ul>
          ) : (
            <p className="text-muted-foreground">
              No items yet. Create your first item to get started.
            </p>
          )}
        </Card>
      </div>
    </main>
  )
}
```

Important: Do NOT use optional chaining (`auth?.`) anywhere after the `if (!auth)` guard. TypeScript narrows the type after the null check.
  </action>
  <verify>
1. Verify null check pattern: `grep "if (!auth)" src/app/page.tsx` should match
2. Verify no optional chaining on auth: `grep -c "auth?\." src/app/page.tsx` should return 0
3. Verify new auth fields: `grep "auth.tenantSlug\|auth.role\|auth.email\|auth.name" src/app/page.tsx` should show all four
4. Verify welcome message: `grep "auth.name || auth.email" src/app/page.tsx` should match
5. Verify "Not Authenticated" early return: `grep "Not Authenticated" src/app/page.tsx` should match
  </verify>
  <done>
- page.tsx uses `if (!auth)` null check with early return showing "Not Authenticated" card
- Welcome message shows `auth.name || auth.email`
- Auth Context card displays tenantSlug, role, email, userId
- No optional chaining on auth after null check
- withTenant call is unconditional after null check
  </done>
</task>

</tasks>

<verification>
1. `grep -c "getAuthContext" src/app/layout.tsx` returns 0 (no auth call in layout)
2. `grep -c "async" src/app/layout.tsx` returns 0 (layout is synchronous)
3. `grep "if (!auth)" src/app/page.tsx` matches (null check pattern)
4. `grep -c "auth?\." src/app/page.tsx` returns 0 (no optional chaining)
5. `grep "auth.tenantSlug" src/app/page.tsx` matches (new fields used)
6. `head -1 src/app/actions/auth.ts` shows `'use server'`
7. `grep "redirect.*logout" src/app/actions/auth.ts` matches
</verification>

<success_criteria>
- Root layout.tsx has no getAuthContext import, is not async, and body has utility classes
- page.tsx uses AuthContext v0.2.0 null-check pattern with auth.name, auth.email, auth.role, auth.tenantSlug
- src/app/actions/auth.ts exists with 'use server' directive and redirect to PLATFORM_URL/logout
- No optional chaining on auth after null check in page.tsx
</success_criteria>

<output>
After completion, create `.planning/phases/03-app-code-cicd/03-01-SUMMARY.md`
</output>
