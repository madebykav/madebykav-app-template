---
phase: 04-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [CLAUDE.md, README.md]
autonomous: true
requirements: [DOCS-02, DOCS-03]

must_haves:
  truths:
    - "CLAUDE.md documents AuthContext v0.2.0 returning null (not object with null fields), with correct 6-field interface"
    - "CLAUDE.md shows withTenant imported from @madebykav/db directly (not from @/lib/db)"
    - "CLAUDE.md documents declarative RLS via pgPolicy() + createTenantPolicy() (not tenantRlsPolicy)"
    - "CLAUDE.md includes Docker build command with --secret flag for BuildKit"
    - "CLAUDE.md documents health probe endpoints (/api/health and /api/health/ready)"
    - "CLAUDE.md 'Things to Avoid' includes never calling getAuthContext in root layout and never validating sessions"
    - "README.md includes ./dev.sh one-command quick start"
    - "README.md includes Docker deployment section with BuildKit secrets"
    - "README.md SDK table lists @madebykav/ai as optional (not core dependency)"
    - "No v1 vestiges: no tenantRlsPolicy, no auth.session, no auth.user sub-object, no @madebykav/ai as required"
  artifacts:
    - path: "CLAUDE.md"
      provides: "AI development context for Claude Code and LLM assistants"
      contains: "AuthContext | null"
    - path: "README.md"
      provides: "Developer-facing project documentation with quick start and deployment"
      contains: "dev.sh"
  key_links:
    - from: "CLAUDE.md"
      to: "src/app/page.tsx"
      via: "auth pattern examples match actual implementation"
      pattern: "if \\(!auth\\)"
    - from: "CLAUDE.md"
      to: "src/lib/db/schema.ts"
      via: "RLS pattern examples match actual schema"
      pattern: "pgPolicy.*createTenantPolicy"
    - from: "README.md"
      to: "dev.sh"
      via: "quick start references actual dev script"
      pattern: "dev\\.sh"
---

<objective>
Rewrite CLAUDE.md and README.md to accurately reflect the v2 template state.

Purpose: Both files are completely outdated (v1 patterns, no Docker, no health probes, wrong auth shape). Developers and AI assistants rely on these as primary reference -- inaccurate docs cause incorrect code generation and wasted time.

Output: CLAUDE.md and README.md fully reflecting actual codebase state.
</objective>

<execution_context>
@/Users/kavinda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kavinda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-documentation/04-RESEARCH.md

# Source of truth for content (spec guidance, but verify against actual files):
@APP-TEMPLATE-UPDATE-FINAL.md (lines 681-853 for CLAUDE.md, lines 856-907 for README.md)

# Ground truth files (actual implementations to verify examples against):
@src/app/layout.tsx
@src/app/page.tsx
@src/app/actions/auth.ts
@src/app/api/example/route.ts
@src/app/api/health/route.ts
@src/app/api/health/ready/route.ts
@src/lib/db/index.ts
@src/lib/db/schema.ts
@src/app/globals.css
@Dockerfile
@docker-compose.yml
@dev.sh
@.env.example
@next.config.ts
@package.json
@.github/workflows/docker-publish.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite CLAUDE.md with v2 patterns, Docker, and architecture context</name>
  <files>CLAUDE.md</files>
  <action>
  Full rewrite of CLAUDE.md from blank. Follow spec sections (APP-TEMPLATE-UPDATE-FINAL.md lines 681-853) as content guide, but verify every code example against actual source files. The codebase is ground truth; the spec is guidance.

  **Required sections (in order):**

  1. **Project Overview** -- Architecture context: proxy auth via Caddy + auth-validator, each app owns its own PostgreSQL database, multi-tenant via RLS, Docker containers routed by subdomain. Include the ASCII request flow diagram from the spec (Browser -> Caddy -> Auth Validator -> App Container -> Response). Key facts: auth at proxy layer, app-owned DB, RLS for tenant isolation.

  2. **Folder Structure** -- Updated tree including health probes, actions/auth.ts, globals.css. Match actual file layout:
     ```
     src/
     ├── app/
     │   ├── layout.tsx         # Root layout (synchronous, no auth call)
     │   ├── page.tsx           # Dashboard page
     │   ├── globals.css        # Tailwind v4 + UI theme imports
     │   ├── actions/
     │   │   └── auth.ts        # Logout server action
     │   └── api/
     │       ├── example/
     │       │   └── route.ts   # Example CRUD endpoints
     │       └── health/
     │           ├── route.ts         # Liveness probe
     │           └── ready/route.ts   # Readiness probe
     ├── lib/
     │   └── db/
     │       ├── index.ts       # Database connection (exports db, Database type)
     │       └── schema.ts      # Drizzle schema with declarative RLS
     └── components/            # App-specific components (create as needed)
     ```

  3. **SDK Packages** -- Three packages (NO @madebykav/ai):

     - `@madebykav/auth` (v0.2.0): Show AuthContext interface with exact 6 fields (tenantId, userId, email, name, role, tenantSlug). Show getAuthContext() returning AuthContext | null, requireAuth() throwing 401, isStandaloneMode(). Import: `import { getAuthContext, requireAuth, isStandaloneMode, type AuthContext } from '@madebykav/auth'`

     - `@madebykav/db` (v0.1.0): Show withTenant, withoutRLS, createTenantPolicy imports FROM `@madebykav/db`. Show declarative RLS schema pattern with pgPolicy() + createTenantPolicy() as third arg to pgTable. Note: each app owns its own DB, so table names don't need app-slug prefixes. Show insert pattern with tenantId.

     - `@madebykav/ui` (v0.1.2): Components (Button, Card, Input). Import cn from `@madebykav/ui/lib/utils` (NOT from `@madebykav/ui`).

  4. **RLS and Tenant Isolation** -- Brief section: every table needs tenant_id, always query through withTenant(), always include tenantId in inserts, RLS defined declaratively in schema via pgPolicy() + createTenantPolicy(). Show schema pattern matching actual schema.ts.

  5. **Common Patterns** -- Three patterns:
     - Server Component (match actual page.tsx pattern: null check with `if (!auth)`, not `if (!auth.tenantId)`)
     - Protected API Route (match actual route.ts: requireAuth(), withTenant(), satisfies pattern for inserts)
     - Server Action (match actual auth.ts pattern for logout; show generic data mutation pattern with requireAuth + revalidatePath)

  6. **Commands** -- Table format including:
     - pnpm dev, pnpm build, pnpm start, pnpm lint
     - pnpm db:generate, pnpm db:push
     - ./dev.sh (one-command dev setup)
     - docker build --secret id=GITHUB_TOKEN,env=GITHUB_TOKEN -t app . (MUST include --secret flag)
     - docker compose --profile dev up -d

  7. **Environment Variables** -- Match actual .env.example: DATABASE_URL, GITHUB_TOKEN (note: goes in ~/.npmrc), PLATFORM_URL, NEXT_PUBLIC_APP_NAME, NEXT_PUBLIC_APP_SLUG

  8. **Things to Avoid** -- 6 items (not 5):
     1. Never query without withTenant()
     2. Never hardcode tenant IDs
     3. Never use withoutRLS() in app code
     4. Never call getAuthContext() in root layout (forces every page dynamic)
     5. Never validate session cookies in app code (proxy handles auth)
     6. Never store secrets in code

  9. **Debugging** -- Auth issues (check proxy headers, check platform login, use getAuthContext() to inspect), Database issues (check DATABASE_URL, verify RLS policy in schema, verify tenant_id in inserts), Build issues (GITHUB_TOKEN for npm install, TypeScript errors with pnpm build)

  10. **Advanced: Backend Proxy Pattern** -- Include the pattern from spec for apps needing non-JS backends: backend-fetch.ts utility, catch-all proxy route, backend reads x-tenant-id/x-user-id headers. Note this is not needed for typical CRUD apps.

  **Critical verification checklist (MUST pass before writing file):**
  - AuthContext returns null, not { tenantId: null, ... }
  - Null check is `if (!auth)`, not `if (!auth.tenantId)`
  - AuthContext fields: tenantId, userId, email, name, role, tenantSlug (no session, no user sub-object)
  - withTenant imported from @madebykav/db (not from @/lib/db)
  - createTenantPolicy (not tenantRlsPolicy)
  - cn imported from @madebykav/ui/lib/utils
  - No @madebykav/ai section
  - Docker build includes --secret flag
  - Root layout is synchronous (no auth call)
  - Health probe endpoints documented
  </action>
  <verify>
  Read the written CLAUDE.md and verify:
  1. Search for "tenantRlsPolicy" -- must return 0 matches
  2. Search for "auth.session" or "auth.user" (as sub-object) -- must return 0 matches
  3. Search for "@madebykav/ai" -- must return 0 matches (or only as "optional add-on" mention)
  4. Search for "AuthContext | null" -- must return at least 1 match
  5. Search for "if (!auth)" -- must return at least 1 match (not "if (!auth.tenantId)")
  6. Search for "--secret" -- must return at least 1 match in Docker build command
  7. Search for "createTenantPolicy" -- must return at least 1 match
  8. Search for "/api/health" -- must return at least 1 match
  9. Search for "getAuthContext" must NOT appear in layout context (only in page/component patterns)
  </verify>
  <done>
  CLAUDE.md accurately documents v2 template: auth v0.2.0 (null return, 6-field interface), declarative RLS (pgPolicy + createTenantPolicy), Docker with BuildKit secrets, health probes, synchronous root layout, 6 "things to avoid", backend proxy pattern. Zero v1 vestiges.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite README.md with quick start, deployment, and SDK table</name>
  <files>README.md</files>
  <action>
  Full rewrite of README.md from blank. Follow spec sections (APP-TEMPLATE-UPDATE-FINAL.md lines 856-907) as content guide, verify against actual files.

  **Required sections (in order):**

  1. **Title + Description** -- "MadeByKav App Template" with one-line description: tenant-isolated Next.js app template for the MadeByKav platform.

  2. **Quick Start** -- Steps:
     ```
     1. Clone / use as template
     2. Configure .npmrc with GitHub token for @madebykav packages:
        echo "//npm.pkg.github.com/:_authToken=YOUR_TOKEN" >> ~/.npmrc
     3. Copy .env.example to .env.local
     4. pnpm install
     5. ./dev.sh  (starts local postgres on port 5433, pushes schema, runs dev server)
     ```
     Also show manual alternative: `docker compose --profile dev up -d && pnpm db:push && pnpm dev`

  3. **Deployment** -- Two paths:
     - **Vercel:** Connect repo, set env vars, push to deploy.
     - **Docker:** `docker build --secret id=GITHUB_TOKEN,env=GITHUB_TOKEN -t my-app .` (MUST include --secret flag). Brief note about platform admin registering app and deploying via admin panel. Accessible at `{app-slug}.madebykav.com`.

  4. **Project Structure** -- Match actual folder structure tree (same as CLAUDE.md task). Include brief annotations for each file.

  5. **SDK Packages** -- Table format:
     | Package | Version | Purpose |
     | @madebykav/auth | ^0.2.0 | Read identity from platform proxy headers |
     | @madebykav/db | ^0.1.0 | RLS tenant isolation (withTenant, createTenantPolicy) |
     | @madebykav/ui | ^0.1.2 | Shared UI components (Button, Card, Input, etc.) |
     | @madebykav/ai | optional | AI capabilities (add when needed: pnpm add @madebykav/ai) |

  6. **Commands** -- Table format matching actual package.json scripts + Docker:
     | Command | Description |
     | pnpm dev | Start dev server |
     | pnpm build | Production build |
     | pnpm lint | Run ESLint |
     | pnpm db:generate | Generate migrations from schema changes |
     | pnpm db:push | Push schema to database |
     | ./dev.sh | One-command dev setup (postgres + schema + dev server) |
     | docker build --secret ... | Build Docker image |

  7. **Tenant Isolation** -- Brief explanation: multi-tenant via RLS, withTenant() scopes all queries, tenant_id column required on every table. Short code example showing withTenant usage.

  8. **Health Probes** -- Brief section: GET /api/health (liveness, no DB check), GET /api/health/ready (readiness, checks DB connectivity).

  9. **AI Development** -- One line: "See CLAUDE.md for AI development context and patterns."

  **Critical verification checklist:**
  - ./dev.sh mentioned in Quick Start
  - Docker build command includes --secret flag
  - @madebykav/ai listed as "optional" (not core)
  - No references to tenantRlsPolicy or manual RLS SQL
  - Version numbers match actual package.json (auth ^0.2.0, db ^0.1.0, ui ^0.1.2)
  </action>
  <verify>
  Read the written README.md and verify:
  1. Search for "dev.sh" -- must return at least 1 match
  2. Search for "--secret" -- must return at least 1 match
  3. Search for "tenantRlsPolicy" -- must return 0 matches
  4. Search for "optional" near "@madebykav/ai" -- must return at least 1 match
  5. Search for "^0.2.0" -- must return at least 1 match (auth version)
  6. Search for "/api/health" -- must return at least 1 match
  </verify>
  <done>
  README.md includes quick start with dev.sh, Docker deployment with BuildKit secrets, correct SDK version table with @madebykav/ai as optional, project structure with health probes, and tenant isolation section. Zero v1 vestiges.
  </done>
</task>

</tasks>

<verification>
1. CLAUDE.md exists and contains all 10 sections (Project Overview through Backend Proxy Pattern)
2. README.md exists and contains all 9 sections (Title through AI Development)
3. Zero occurrences of "tenantRlsPolicy" in either file
4. Zero occurrences of "auth.session" or "auth.user" (as sub-object accessor) in either file
5. "@madebykav/ai" does not appear as a core/required dependency in either file
6. Docker build commands include --secret flag in both files
7. AuthContext documented as returning null (not object with null fields) in CLAUDE.md
8. Health probe endpoints documented in both files
</verification>

<success_criteria>
Both CLAUDE.md and README.md accurately reflect the v2 template state. A developer cloning the repo gets correct quick-start instructions. An AI assistant reading CLAUDE.md generates code using v0.2.0 auth patterns, declarative RLS, and proper Docker commands. No v1 patterns survive in either file.
</success_criteria>

<output>
After completion, create `.planning/phases/04-documentation/04-01-SUMMARY.md`
</output>
